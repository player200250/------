<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å“¡å·¥æ‰“å¡ç³»çµ± - è˜Šæœˆæ¬å®¶å…¬å¸</title>
    <link rel="stylesheet" href="employee.css">
    <style>
        .punch-box {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .time-display {
            font-size: 3rem;
            color: #c2185b;
            font-weight: bold;
            margin: 20px 0;
        }
        .data-preview {
            text-align: left;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .btn-punch-main {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 60px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }
        .btn-punch-main:disabled { background: #ccc; cursor: not-allowed; }
        .field-label { color: #888; font-weight: bold; }
    </style>
</head>
<body style="background-color: #fce4ec;">

    <div class="punch-box">
        <h2 style="color: #c2185b;">ğŸ“ æ¯æ—¥å‡ºå‹¤æ‰“å¡</h2>

        <div id="date-now" style="color: #666;">2026-01-12</div>
        <div class="time-display" id="time-now">00:00:00</div>

        <div class="data-preview">
            <p><span class="field-label">å“¡å·¥ç·¨è™Ÿï¼š</span> <span id="field-emp-id">EMP888</span></p>
            <p><span class="field-label">æœ¬æ—¥ç­åˆ¥ï¼š</span> <span id="field-shift-type">å›ºå®šç­ (08:00-17:00)</span></p>

            <p><span class="field-label">æ‰“å¡é¡å‹ï¼š</span>
                <select id="field-punch-type" style="padding: 5px; border-radius: 5px;">
                    <option value="ä¸Šç­">ğŸŒ… ä¸Šç­æ‰“å¡</option>
                    <option value="ä¸‹ç­">ğŸŒ™ ä¸‹ç­æ‰“å¡</option>
                    <option value="æš«é›¢">â˜• æš«æ™‚é›¢é–‹</option>
                    <option value="å›å´—">ğŸ”™ è¿”å›å´—ä½</option>
                </select>
            </p>

            <p><span class="field-label">æ‰“å¡åœ°é»ï¼š</span> <span id="field-location">å–å¾—ä¸­...</span></p>

            <input type="hidden" id="field-lng">
            <input type="hidden" id="field-lat">
            <input type="hidden" id="hidden-distance">

            <p><span class="field-label">å‚™è¨»äº‹é …ï¼š</span><br>
                <input type="text" id="field-remark" placeholder="å¦‚æœ‰ç‰¹æ®Šç‹€æ³è«‹è¨»æ˜"
                    style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
            </p>
        </div>

        <button class="btn-punch-main" id="btn-submit" onclick="handlePunchSubmit()">ç¢ºèªæ‰“å¡</button>
    </div>

    <script>
        // 1. å³æ™‚æ™‚é˜
        function updateClock() {
            const now = new Date();
            document.getElementById('time-now').innerText = now.toTimeString().split(' ')[0];
            document.getElementById('date-now').innerText = now.toLocaleDateString();
        }
        setInterval(updateClock, 1000);

        // 2. æ¨¡æ“¬å®šä½ (æœªä¾†å¯æ¥çœŸæ­£çš„ navigator.geolocation)
        setTimeout(() => {
            document.getElementById('field-location').innerText = "å°ä¸­å¸‚å—å±¯å€äº”æ¬Šè¥¿è·¯äºŒæ®µ";
            document.getElementById('field-lat').value = 24.143;
            document.getElementById('field-lng').value = 120.640;
            document.getElementById('hidden-distance').value = 0.12; 
        }, 1000);

        // 3. æ‰“å¡æäº¤é‚è¼¯
        function handlePunchSubmit() {
            const now = new Date();
            const hour = now.getHours();
            const dist = parseFloat(document.getElementById('hidden-distance').value) || 0;
            const btn = document.getElementById('btn-submit');

            // --- é€²éšé‚è¼¯ï¼šæ ¹æ“šç­åˆ¥æ™‚æ®µåˆ¤å®šç‹€æ…‹ ---
            let status = "æ­£å¸¸"; 
            // å‡è¨­æ˜¯å›ºå®šç­ 08:00 ä¸Šç­ï¼Œè¶…é 8 é»ä¸”æ˜¯ã€Œä¸Šç­ã€é¡å‹å‰‡éœ€å¯©æ ¸
            if (document.getElementById('field-punch-type').value === "ä¸Šç­" && hour >= 8) {
                status = "å¾…å¯©æ ¸";
            }
            // åœ°é»å¤ªé ä¹Ÿå¼·åˆ¶å¾…å¯©æ ¸
            if (dist >= 0.5) status = "å¾…å¯©æ ¸";

            // --- ä¾ç…§ ER åœ–å®Œæ•´æ‰“åŒ… ---
            const punchRecord = {
                attendanceId: 1, // é—œè¯å‡ºå‹¤ç¸½è¡¨
                punchTime: now.toISOString(),
                punchType: document.getElementById('field-punch-type').value, // 'ä¸Šç­','ä¸‹ç­','æš«é›¢','å›å´—'
                sourceType: "ç¶²ç«™", // ç¬¦åˆ CHECK ç´„æŸ
                punchLocation: document.getElementById('field-location').innerText,
                punchLat: parseFloat(document.getElementById('field-lat').value),
                punchLng: parseFloat(document.getElementById('field-lng').value),
                distanceFromSite: dist,
                isValidLocation: dist < 0.5 ? 1 : 0, // BIT é¡å‹
                punchStatus: status, // 'æ­£å¸¸','å¾…å¯©æ ¸' ç­‰
                attendanceNote: document.getElementById('field-remark').value
            };

            btn.disabled = true;
            btn.innerText = "è³‡æ–™é€å‡ºä¸­...";

            console.log("ä¸»äººï¼å·²æˆåŠŸæ‰“åŒ…å°é½Š ER åœ–çš„è³‡æ–™ï¼š", punchRecord);
            alert(`æ‰“å¡æˆåŠŸï¼ç›®å‰ç‹€æ…‹ï¼š${status} (à¹‘>â—¡<à¹‘)`);
            window.location.href = 'user_portal.html';
        }
    </script>
</body>
</html>